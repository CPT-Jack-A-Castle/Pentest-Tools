
class ServicesReport:
    def __init__(self, nmap_report):
        self.nmap_report = nmap_report
        self.services = []

        for host in self.nmap_report.hosts:
            for port in host.ports:
                s = ServiceEntry(port.service.name)
                if s in self.services:
                    index = self.services.index(s)
                    s = self.services[index]
                else:
                    self.services.append(s)
                if not host in s.hosts:
                    s.hosts.append(host)

    def markdown(self):
        result = "# Services\n\n"

        index = 0
        for entry in self.services:
            result += "## %s\n\n" % (entry.name)
            
            result += "<textarea id=\"service_hosts_%i\" style=\"display:none;\">\n" % (index)
            for host in entry.hosts:
                result += "%s\n" % (host.addr)
            result += "</textarea>\n"

            result += "<textarea id=\"service_hosts_ports_%i\" style=\"display:none;\">\n" % (index)
            for host in entry.hosts:
                for port in host.ports:
                    result += "%s:%i\n" % (host.addr, port.portid)
            result += "</textarea>\n"

            result += "<div style=\"display:table;\">"
            result += "<button onclick=\"tmp=document.getElementById('service_hosts_%i');tmp.style='';tmp.select();tmp.setSelectionRange(0, 99999);document.execCommand('copy');tmp.style='display:none;';\" style='float:left;'>Copy host list</button>" % (index)
            result += "<button onclick=\"tmp=document.getElementById('service_hosts_ports_%i');tmp.style='';tmp.select();tmp.setSelectionRange(0, 99999);document.execCommand('copy');tmp.style='display:none;';\" style='float:left;'>Copy host:port list</button>" % (index)
            result += "</div>\n\n"

            result += "| TARGET | PORT | VERSION |\n"
            result += "| --- | --- | ---|\n"
            for host in entry.hosts:
                for port in host.ports:
                    if port.service.name == entry.name:
                        result += "| %s | %i | %s |\n" % (host.addr, port.portid, port.service.getfullversion())
            result += "\n\n"

            index += 1

        return result

class ServiceEntry:
    def __init__(self, service_name):
        self.name = service_name
        self.hosts = []
    
    def __eq__(self, other):
        if isinstance(other, ServiceEntry):
            return self.name == other.name
        return NotImplemented
    
    def __str__(self):
        return "ServiceEntry: name='%s' nb_hosts=%i" % (self.name, len(self.hosts))
