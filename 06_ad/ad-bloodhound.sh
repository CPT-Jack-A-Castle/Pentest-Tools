#!/bin/bash

SCRIPT_PATH=$(readlink -f "${BASH_SOURCE[0]}")
SCRIPT_DIR=$(dirname "$SCRIPT_PATH")
AD_HELPER="${SCRIPT_DIR}/ad-helper.sh"

source "$AD_HELPER" || exit
is_workspace_directory || exit

if [ $# -eq 1 ]
then
    domain="${1}"

    # 1. Get the domain FQDN
    dom=$(db_select "domain" "${domain}") || exit
    dom_fqdn=$(echo "${dom}" | cut -d'|' -f3)
    print_info "FQDN of the domain to target (${COLOR_CYAN_BOLD}${domain}${COLOR_RST}) -> ${COLOR_CYAN_BOLD}${dom_fqdn}${COLOR_RST}"

    # 2. Get the FQDN of a DC
    dc_fqdn=$(get_dc_for_domain "${domain}" 2) || exit
    print_info "FQDN of the target DC -> ${COLOR_CYAN_BOLD}${dc_fqdn}${COLOR_RST}"

    # 3. Get some user credentials
    user=$(get_user_for_domain "${domain}") || exit
    user_domain=$(echo "${user}" | cut -d'|' -f1)
    user_name=$(echo "${user}" | cut -d'|' -f2)
    user_password=$(get_user_password "${user_domain}" "${user_name}") || exit
    print_info "Credentials to use -> ${COLOR_CYAN_BOLD}${user_domain}\\${user_name}${COLOR_RST}:${COLOR_CYAN_BOLD}${user_password}${COLOR_RST}"

    # 4. Find a DNS server
    dns=$(get_dns_servers) || exit
    dns_ip=$(echo "${dns}" | head -n1)
    print_info "Target DNS server -> ${COLOR_CYAN_BOLD}${dns_ip}${COLOR_RST}"

    # Format command
    is_nt_hash "${user_password}"
    if [ $? -eq 0 ]
    then
        command="cd recon ; bloodhound-python -c All,LoggedOn -u '${user_name}' --hashes '${user_password}:${user_password}' -d '${dom_fqdn}' -ns '${dns_ip}' -dc '${dc_fqdn}' --dns-tcp --zip ; cd .."
    else
        command="cd recon ; bloodhound-python -c All,LoggedOn -u '${user_name}' -p '${user_password}' -d '${dom_fqdn}' -ns '${dns_ip}' -dc '${dc_fqdn}' --dns-tcp --zip ; cd .."
    fi

    print_info "Command to execute: ${COLOR_CYAN_BOLD}${command}${COLOR_RST}"
    prompt_confirm || exit

    # Change CWD, exec, and restore CWD
    exec_and_log "${command}"
else
    print_info "Usage: ${0} <DOMAIN>"
fi